# 4Ã—4 (max_move=3) Perfect AI å¼€å‘è¿›åº¦

## ğŸ“‹ é¡¹ç›®çŠ¶æ€

**å½“å‰çŠ¶æ€**: ä»£ç å·²å®Œæˆå¹¶ä¿®å¤bugï¼Œ**ç­‰å¾…å®Œæ•´è®­ç»ƒ**

**æœ€åæ›´æ–°**: 2026-02-08

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. ç­–ç•¥å®ç°
åˆ›å»ºäº†å®Œæ•´çš„4Ã—4 (max_move=3) Perfect AIç­–ç•¥

**æ–‡ä»¶ä½ç½®**: `/home/xiaohu/games/ttt/strategies/perfect4x4_m3/perfect_strategy.py`

**æ ¸å¿ƒç‰¹æ€§**:
- åŸºäº3Ã—3ç­–ç•¥æ”¹å†™ï¼Œé€‚é…4Ã—4æ£‹ç›˜
- ä½¿ç”¨å¯¹ç§°æ€§ä¼˜åŒ–ï¼ˆ8ç§å˜æ¢ï¼‰
- åŸºæ•°17ç¼–ç ï¼ˆä½ç½®0-15ï¼Œpos+1 âˆˆ [1,16]ï¼‰
- æ ‡å‡†å‹æ ‡å‡†åŒ–ï¼ˆcanonical formï¼‰
- åšå¼ˆæ ‘å®Œå…¨æ±‚è§£

### 2. æµ‹è¯•è„šæœ¬
åˆ›å»ºäº†ä¸‰ä¸ªæµ‹è¯•/è®­ç»ƒè„šæœ¬ï¼š

| è„šæœ¬ | è·¯å¾„ | ç”¨é€” |
|------|------|------|
| å°è§„æ¨¡æµ‹è¯• | `test_4x4_m3_training.py` | æµ‹è¯•1000ä¸ªçŠ¶æ€ï¼ŒéªŒè¯ä»£ç æ­£ç¡®æ€§ |
| ä¸­ç­‰æµ‹è¯• | `test_4x4_m3_medium.py` | æµ‹è¯•10000ä¸ªçŠ¶æ€ï¼ŒéªŒè¯ç»ˆå±€åˆ¤æ–­ |
| å®Œæ•´è®­ç»ƒ | `train_4x4_m3_full.py` | **ä¸»è¦ä½¿ç”¨æ­¤è„šæœ¬** |

### 3. UIé›†æˆï¼ˆéƒ¨åˆ†å®Œæˆï¼‰
åœ¨ `display.py` ä¸­å·²æ·»åŠ å¯¼å…¥ï¼š
```python
import strategies.perfect4x4_m3.perfect_strategy as perfect4x4_m3_strategy
```

é…ç½®ç»“æ„å·²æ›´æ–°ä¸ºæ”¯æŒä¸åŒæ£‹ç›˜é…ç½®ç»„åˆã€‚

---

## ğŸ› å·²ä¿®å¤çš„å…³é”®Bug

### Bug 1: SEPARATOR è¿‡å¤§å¯¼è‡´å¾ªç¯ç¼“æ…¢
**é—®é¢˜**:
- åˆå§‹ä»£ç  `SEPARATOR = 100000`ï¼Œå¯¼è‡´ `max_code = 5äº¿`
- æ‰«æç©ºé—´è¿‡å¤§ï¼Œé€Ÿåº¦ææ…¢

**ä¿®å¤**:
- æ”¹ä¸º `SEPARATOR = 5000`ï¼ˆè¶³å¤Ÿå®¹çº³æœ€å¤§code â‰ˆ 4912ï¼‰
- `max_code = 5000 * 5000 = 2500ä¸‡`
- é€Ÿåº¦æå‡çº¦ **20å€**

**å…³é”®ä»£ç ä½ç½®**:
- `encode()`: line 52
- `add_edge()`: line 101
- `train()`: line 288

### Bug 2: KeyError in solve()
**é—®é¢˜**:
- `edge0_[x]` å’Œ `edge1_[x]` è®¿é—®ä¸å­˜åœ¨çš„é”®
- Win/Loseç»ˆå±€çŠ¶æ€å¯èƒ½æ²¡æœ‰å‡ºè¾¹

**ä¿®å¤**:
- æ‰€æœ‰å­—å…¸è®¿é—®æ”¹ä¸º `.get(x, [])`

**ä¿®å¤ä½ç½®**:
- `solve()`: lines 179, 186, 201, 207

### Bug 3: æ—©åœæ¡ä»¶ç¼ºå¤±
**é—®é¢˜**: æ‰¾åˆ°æ‰€æœ‰æ ‡å‡†å‹åä»ç»§ç»­æ‰«æ

**ä¿®å¤**:
```python
if len(canons) >= EXPECTED_CANONICAL_STATES:
    print(f"\nâœ“ å·²æ‰¾åˆ°æ‰€æœ‰ {EXPECTED_CANONICAL_STATES:,} ä¸ªæ ‡å‡†å‹ï¼Œåœæ­¢æšä¸¾")
    break
```

---

## ğŸ”§ å…³é”®æŠ€æœ¯å‚æ•°

### ç¼–ç æ–¹æ¡ˆ

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| åŸºæ•° | 17 | é€‚é…4Ã—4æ£‹ç›˜ï¼ˆpos+1 æœ€å¤§ä¸º16ï¼‰ |
| åˆ†éš”ç¬¦ | 5000 | ç»„åˆç¼–ç ï¼š`x_code * 5000 + y_code` |
| æœ€å¤§å•ä¸ªcode | ~4912 | `16*17^2 + 16*17 + 16` |
| æ€»ç¼–ç ç©ºé—´ | 2500ä¸‡ | `5000 * 5000` |

### çŠ¶æ€ç©ºé—´ç»Ÿè®¡

| æŒ‡æ ‡ | æ•°é‡ | æ¥æº |
|------|------|------|
| ç†è®ºçŠ¶æ€æ•° | 6,337,217 | æ’åˆ—ç»„åˆè®¡ç®— |
| **æ ‡å‡†å‹æ•°é‡** | **792,169** | `count_canonical_states.py` ç²¾ç¡®è®¡ç®— |
| å¯¹ç§°æ€§ç¼©å‡æ¯” | 8.00x | ç†è®ºå€¼ |

---

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### 1. è®­ç»ƒæ•°æ®å†²çª
å¦‚æœé‡åˆ° KeyErrorï¼ˆå¦‚ 32800978ï¼‰ï¼Œéœ€è¦ï¼š
```bash
# åˆ é™¤æ—§çš„è®­ç»ƒæ•°æ®
rm -f /home/xiaohu/games/ttt/strategies/perfect4x4_m3/game_tree_4x4_m3.data

# é‡æ–°è®­ç»ƒ
/home/xiaohu/ls/envs/ttt/bin/python train_4x4_m3_full.py
```

**åŸå› **: SEPARATOR ä» 100000 æ”¹ä¸º 5000ï¼Œæ—§æ•°æ®ç¼–ç ä¸å…¼å®¹

### 2. è¿›åº¦æ˜¾ç¤º
è®­ç»ƒæ—¶ä¼šæ¯ç§’æ˜¾ç¤ºä¸€æ¬¡è¿›åº¦ï¼š
```
è¿›åº¦: 50,000/792,169 (6.3%) | æ‰«æ: 12.5% | é€Ÿåº¦: 450çŠ¶æ€/ç§’ | å‰©ä½™: 14.2åˆ†
```

- **æ ‡å‡†å‹è¿›åº¦**: æœ€é‡è¦çš„æŒ‡æ ‡
- **æ‰«æè¿›åº¦**: å½“å‰åœ¨ç¼–ç ç©ºé—´ä¸­çš„ä½ç½®
- **é€Ÿåº¦**: æ¯ç§’æ‰¾åˆ°çš„æ ‡å‡†å‹æ•°é‡
- **å‰©ä½™æ—¶é—´**: åŸºäºå½“å‰é€Ÿåº¦çš„ä¼°ç®—

### 3. æ€§èƒ½ä¼˜åŒ–
å·²å®æ–½çš„ä¼˜åŒ–ï¼š
- âœ… åªåœ¨ `len(x)>=3` æˆ– `len(y)>=3` æ—¶åˆ¤æ–­èƒœè´Ÿ
- âœ… æ‰¾åˆ°æ‰€æœ‰æ ‡å‡†å‹åç«‹å³åœæ­¢
- âœ… ä½¿ç”¨ `SEPARATOR=5000` å‡å°‘å¾ªç¯æ¬¡æ•°

**é¢„è®¡è®­ç»ƒæ—¶é—´**: 5-15åˆ†é’Ÿï¼ˆå–å†³äºCPUæ€§èƒ½ï¼‰

---

## ğŸ“ ä¸‹ä¸€æ­¥å·¥ä½œæ¸…å•

### ç«‹å³éœ€è¦åšçš„ï¼š

1. **å®Œæ•´è®­ç»ƒ** â­ æœ€ä¼˜å…ˆ
   ```bash
   cd /home/xiaohu/games/ttt
   /home/xiaohu/ls/envs/ttt/bin/python train_4x4_m3_full.py
   ```
   - é¢„è®¡æ—¶é—´ï¼š5-15åˆ†é’Ÿ
   - ç”Ÿæˆæ–‡ä»¶ï¼š`strategies/perfect4x4_m3/game_tree_4x4_m3.data`
   - æ–‡ä»¶å¤§å°ï¼šçº¦10-15 MB

2. **å®Œæˆ UI é›†æˆ**
   - ä¿®æ”¹ `display.py` ä¸­çš„ç­–ç•¥é…ç½®
   - ç¡®ä¿ 4Ã—4 (3-move) æ¨¡å¼ä¸‹å¯ä»¥é€‰æ‹© Perfect AI
   - æµ‹è¯•åˆ‡æ¢æ˜¯å¦æµç•…

3. **éªŒè¯è®­ç»ƒç»“æœ**
   è®­ç»ƒå®Œæˆåæ£€æŸ¥ï¼š
   ```python
   # åº”è¯¥çœ‹åˆ°ï¼š
   æ€»çŠ¶æ€æ•°: 792,169
   WinçŠ¶æ€æ•°: ~35,000-40,000
   LoseçŠ¶æ€æ•°: ~30,000-35,000

   åˆå§‹çŠ¶æ€ dp å€¼: [1, X] æˆ– [-1, X]
   ç»“è®º: å…ˆæ‰‹(X)å¿…èƒœ æˆ– åæ‰‹(O)å¿…èƒœ
   ```

4. **å®é™…æ¸¸æˆæµ‹è¯•**
   - åœ¨ UI ä¸­ä¸ Perfect AI å¯¹æˆ˜
   - éªŒè¯ AI å†³ç­–æ˜¯å¦åˆç†
   - æ£€æŸ¥æ˜¯å¦æœ‰bugï¼ˆå¦‚èµ°éæ³•ä½ç½®ï¼‰

### å¯é€‰çš„åç»­å·¥ä½œï¼š

5. **4Ã—4 (max_move=4) å®ç°**
   - æ ‡å‡†å‹æ•°é‡ï¼šä¼°è®¡ ~7300ä¸‡ï¼ˆåŸºäºç¼©å‡æ¯”ä¾‹ï¼‰
   - è®­ç»ƒæ—¶é—´ï¼šå¯èƒ½éœ€è¦1-2å°æ—¶
   - å†…å­˜éœ€æ±‚ï¼š~1 GB
   - å¯ä»¥å¤ç”¨ç›¸åŒä»£ç æ¡†æ¶

6. **æ€§èƒ½åˆ†æ**
   - ç»Ÿè®¡ä¸åŒçŠ¶æ€çš„ dp å€¼åˆ†å¸ƒ
   - åˆ†æå…ˆæ‰‹ä¼˜åŠ¿ç¨‹åº¦
   - ç”Ÿæˆç­–ç•¥åˆ†ææŠ¥å‘Š

7. **æ–‡æ¡£å®Œå–„**
   - æ·»åŠ èƒœè´Ÿåˆ†æ
   - å†™ç­–ç•¥è§£é‡Šæ–‡æ¡£
   - æ›´æ–° README

---

## ğŸ—‚ï¸ æ–‡ä»¶æ¸…å•

### æ ¸å¿ƒæ–‡ä»¶
```
/home/xiaohu/games/ttt/
â”œâ”€â”€ strategies/
â”‚   â””â”€â”€ perfect4x4_m3/
â”‚       â””â”€â”€ perfect_strategy.py          # æ ¸å¿ƒç­–ç•¥å®ç° â­
â”œâ”€â”€ test_4x4_m3_training.py              # å°è§„æ¨¡æµ‹è¯•ï¼ˆ1000çŠ¶æ€ï¼‰
â”œâ”€â”€ test_4x4_m3_medium.py                # ä¸­ç­‰æµ‹è¯•ï¼ˆ10000çŠ¶æ€ï¼‰
â”œâ”€â”€ train_4x4_m3_full.py                 # å®Œæ•´è®­ç»ƒè„šæœ¬ â­
â”œâ”€â”€ count_canonical_states.py            # æ ‡å‡†å‹è®¡æ•°å·¥å…·
â””â”€â”€ display.py                           # UIï¼ˆéœ€å®Œæˆé›†æˆï¼‰
```

### è®­ç»ƒæ•°æ®ï¼ˆå¾…ç”Ÿæˆï¼‰
```
strategies/perfect4x4_m3/game_tree_4x4_m3.data  # è®­ç»ƒå®Œæˆåç”Ÿæˆ
```

---

## ğŸ’¡ æŠ€æœ¯è¦ç‚¹å¤‡å¿˜

### å¯¹ç§°å˜æ¢çŸ©é˜µï¼ˆ4Ã—4ï¼‰
```python
# ä½ç½®ç¼–å·: 0  1  2  3
#          4  5  6  7
#          8  9 10 11
#         12 13 14 15

transforms = [
    [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],    # æ’ç­‰
    [3,7,11,15,2,6,10,14,1,5,9,13,0,4,8,12],    # é€†æ—¶é’ˆ90Â°
    [15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,0],    # 180Â°
    [12,8,4,0,13,9,5,1,14,10,6,2,15,11,7,3],    # é¡ºæ—¶é’ˆ90Â°
    [3,2,1,0,7,6,5,4,11,10,9,8,15,14,13,12],    # æ°´å¹³ç¿»è½¬
    [12,13,14,15,8,9,10,11,4,5,6,7,0,1,2,3],    # å‚ç›´ç¿»è½¬
    [0,4,8,12,1,5,9,13,2,6,10,14,3,7,11,15],    # ä¸»å¯¹è§’çº¿
    [15,11,7,3,14,10,6,2,13,9,5,1,12,8,4,0],    # å‰¯å¯¹è§’çº¿
]
```

### èƒœè´Ÿåˆ¤æ–­è§„åˆ™
- éœ€è¦ **3ä¸ªè¿ç»­** çš„ç›¸åŒæ£‹å­ï¼ˆæ¨ª/ç«–/æ–œï¼‰
- max_move=3ï¼Œæ‰€ä»¥æœ€å¤šä¿ç•™3ä¸ªæ£‹å­
- åˆ¤æ–­æ—¶æœºï¼š`len(x)>=3` æˆ– `len(y)>=3`

### ç­–ç•¥ç¼“å­˜æœºåˆ¶
`display.py` ä¸­ä½¿ç”¨ `strategy_cache` é¿å…é‡å¤åŠ è½½ï¼š
```python
cache_key = (module_name, board_size, max_move)
if cache_key in self.strategy_cache:
    instance = self.strategy_cache[cache_key]
    instance.game = self.game  # æ›´æ–°gameå¼•ç”¨ âš ï¸ é‡è¦
```

---

## ğŸ” è°ƒè¯•å‘½ä»¤

### æŸ¥çœ‹è®­ç»ƒæ•°æ®æ˜¯å¦å­˜åœ¨
```bash
ls -lh /home/xiaohu/games/ttt/strategies/perfect4x4_m3/
```

### æ‰‹åŠ¨æµ‹è¯•ç­–ç•¥åŠ è½½
```python
from Game import GameBase
import strategies.perfect4x4_m3.perfect_strategy as s

game = GameBase(4, 3)
strategy = s.Strategy(game)
# åº”è¯¥çœ‹åˆ°: "å·²åŠ è½½è®­ç»ƒæ•°æ®: XXX ä¸ªçŠ¶æ€" æˆ– "æœªæ‰¾åˆ°è®­ç»ƒæ•°æ®"
```

### æ£€æŸ¥ç¼–ç æ­£ç¡®æ€§
```python
sym = s.SymmetryHelper()
# æµ‹è¯•ä½ç½® [0,1,2] ç¼–ç 
code = sym.encode([0,1,2], [])
print(f"ç¼–ç : {code}")
# åº”è¯¥ < 5000 * 5000 = 25,000,000
```

---

## ğŸ“ å…³é”®å†³ç­–è®°å½•

### ä¸ºä»€ä¹ˆé€‰æ‹© SEPARATOR=5000ï¼Ÿ
- å•ä¸ªcodeæœ€å¤§å€¼ï¼š`16*17^2 + 16*17 + 16 = 4912`
- 5000 ç•™äº†å°ä½™é‡ï¼Œä¸”æ˜¯æ•´æ•°
- æ¯”100000å°å¾—å¤šï¼Œå¤§å¹…æå‡æ€§èƒ½

### ä¸ºä»€ä¹ˆæ ‡å‡†å‹æ•°é‡æ˜¯ 792,169ï¼Ÿ
- é€šè¿‡ `count_canonical_states.py` ç²¾ç¡®æšä¸¾è®¡ç®—
- éªŒè¯äº†å¯¹ç§°æ€§ç¼©å‡æ¯”ä¾‹çº¦ä¸º 8xï¼ˆç¬¦åˆç†è®ºï¼‰

### ä¸ºä»€ä¹ˆç”¨åŸºæ•°17ï¼Ÿ
- 4Ã—4æ£‹ç›˜ä½ç½® 0-15
- pos+1 èŒƒå›´ 1-16ï¼ˆé¿å…0å†²çªï¼‰
- éœ€è¦åŸºæ•° â‰¥17

---

## ğŸ¯ é¢„æœŸæœ€ç»ˆç»“æœ

è®­ç»ƒæˆåŠŸåï¼Œåº”è¯¥èƒ½å¤Ÿï¼š
1. âœ… åœ¨ UI çš„ 4Ã—4 (3-move) æ¨¡å¼ä¸‹é€‰æ‹© Perfect AI
2. âœ… AI èƒ½å³æ—¶å“åº”ï¼Œæ— éœ€é‡æ–°åŠ è½½
3. âœ… AI é‡‡ç”¨æœ€ä¼˜ç­–ç•¥ï¼ˆå¿…èƒœ/å¿…è´¥/æœ€ä½³å»¶é•¿ï¼‰
4. âœ… éªŒè¯æ¸¸æˆå…¬å¹³æ€§ï¼ˆå…ˆæ‰‹å¿…èƒœ or åæ‰‹å¿…èƒœ or å¹³å±€ï¼‰

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- çŠ¶æ€ç©ºé—´åˆ†æï¼š`docs/4x4_feasibility_analysis.md`ï¼ˆå¾…åˆ›å»ºï¼‰
- 3Ã—3ç­–ç•¥å‚è€ƒï¼š`strategies/perfect3x3/perfect_strategy.py`
- æ¸¸æˆè§„åˆ™ï¼š`README.md`

---

**å‡†å¤‡å°±ç»ªï¼ä¸‹ä¸€ä¸ªClaudeä¼šè¯åªéœ€è¿è¡Œå®Œæ•´è®­ç»ƒå³å¯ã€‚**
